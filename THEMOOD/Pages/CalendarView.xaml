<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:THEMOOD.ViewModels"
             xmlns:controls="clr-namespace:THEMOOD.Controls"
             x:Class="THEMOOD.Pages.CalendarView"
             Title="Mood Calendar">

    <ContentPage.BindingContext>
        <vm:CalendarView_VM/>
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto, Auto, *, Auto">
        <!-- Month Navigation -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto" Padding="20,10">
            <Button Grid.Column="0"
                      Text="&lt;"
                      Command="{Binding PreviousMonthCommand}"
                      HeightRequest="40"
                      WidthRequest="40"
                      CornerRadius="20"/>

            <Label Grid.Column="1"
                   Text="{Binding CurrentMonth, StringFormat='{0:MM yyyy}'}" 
                   FontSize="24"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>

            <Button Grid.Column="2"
                    Text="&gt;"
                    Command="{Binding NextMonthCommand}"
                    HeightRequest="40"
                    WidthRequest="40"
                    CornerRadius="20"/>
        </Grid>

        <!-- Mood Filter -->
        <HorizontalStackLayout Grid.Row="1" Spacing="10" Padding="20,0,20,10">
            <Label Text="MOODS"
                   VerticalOptions="Center"
                   FontAttributes="Bold"/>
            <Picker ItemsSource="{Binding MoodFilters}"
                    SelectedItem="{Binding SelectedFilter}"
                    WidthRequest="120"
                    SelectedIndexChanged="MoodFilter_SelectedIndexChanged"/>
        </HorizontalStackLayout>

        <!-- Days of Week Header -->
        <Grid Grid.Row="2" RowDefinitions="Auto, *">
            <Grid Grid.Row="0" ColumnDefinitions="*,*,*,*,*,*,*" Padding="10,5">
                <Label Grid.Column="0" Text="Sun" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="1" Text="Mon" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="2" Text="Tue" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="3" Text="Wed" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="4" Text="Thu" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="5" Text="Fri" HorizontalOptions="Center" FontAttributes="Bold" />
                <Label Grid.Column="6" Text="Sat" HorizontalOptions="Center" FontAttributes="Bold" />
            </Grid>

            <!-- Calendar Grid -->
            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding DaysInMonth}"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="7"
                                     HorizontalItemSpacing="0"
                                     VerticalItemSpacing="0"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="2" BackgroundColor ="Transparent">
                            <Frame BackgroundColor="{Binding MoodColor}"
                                   CornerRadius="25"
                                   HeightRequest="50"
                                   WidthRequest="50"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   IsVisible="{Binding HasMood}"
                                   Opacity="{Binding IsFiltered, Converter={StaticResource BoolToOpacityConverter}, ConverterParameter=0.3:1.0}">
                                <Label Text="{Binding MoodIcon}"
                                       FontSize="24"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Frame>

                            <Grid BackgroundColor="Transparent" Padding="5">
                                <Label Text="{Binding Date.Day}"
                                       VerticalOptions="Start"
                                       HorizontalOptions="Start"
                                       IsVisible="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}}" />
                            </Grid>

                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CalendarView_VM}}, Path=ViewDayDetailsCommand}"
                                    CommandParameter="{Binding}"/>

                                <LongPressGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CalendarView_VM}}, Path=AddMoodForDayCommand}"
                                    CommandParameter="{Binding}"/>
                            </Grid.GestureRecognizers>
                        </Grid>

                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- Navigation Bar -->
        <controls:CustomNavBar Grid.Row="3" x:Name="NavBar" />
    </Grid>

</ContentPage>